# 发票解析功能改进说明

## 概述
本次更新主要解决了PDF发票解析功能的问题，并增加了用户友好的解析状态跟踪和手动重新解析功能。

## 主要变更

### 1. 数据库模型增强
在 `Invoice` 模型中新增了以下字段：

- **parse_status** (string): 解析状态
  - `pending`: 等待解析
  - `parsing`: 解析中
  - `success`: 解析成功
  - `failed`: 解析失败

- **parse_error** (string, nullable): 存储解析失败时的错误信息

- **raw_text** (string, nullable): 保存OCR提取的原始文本，便于调试和用户查看

### 2. OCR服务改进
- 在 `RecognizePDF` 和 `extractTextFromPDF` 函数中添加了详细的日志输出
- 改进了错误处理和报告机制
- 确保文件路径处理的正确性
- 原始文本会被保存到数据库，便于前端展示

### 3. 发票服务重构
- 提取了公共的解析逻辑到 `parseInvoicePDF` 辅助方法，减少代码重复
- `Create` 方法现在会跟踪和保存解析状态
- 新增 `Reparse` 方法，允许手动重新触发发票解析

### 4. 新增 API 端点
**POST /api/invoices/:id/parse**

允许用户手动重新解析已上传的发票。适用场景：
- 首次上传时解析失败
- OCR服务升级后重新识别历史发票
- 调试发票识别问题

### 5. 前端界面改进
在发票详情弹窗中添加了以下功能：

1. **解析状态显示**
   - 带颜色编码的状态标签
   - 解析中时显示加载动画
   - 清晰的状态说明

2. **错误信息展示**
   - 解析失败时显示具体错误原因
   - 帮助用户了解问题所在

3. **原始文本查看**
   - 可折叠的OCR原始文本展示区域
   - 便于用户验证识别结果和调试问题

4. **重新解析按钮**
   - 一键重新触发解析
   - 带加载状态和禁用保护
   - 防止重复请求

## 技术实现细节

### 后端
- 使用 Go 语言实现
- 利用 `ledongthuc/pdf` 库进行PDF文本提取
- 使用 Tesseract OCR 处理扫描版PDF
- GORM 自动处理数据库迁移

### 前端
- Vue 3 + TypeScript
- Element Plus UI 组件
- 响应式状态管理
- 优雅的加载和错误状态处理

## 使用说明

### 上传发票
1. 点击"上传发票"按钮
2. 选择PDF文件
3. 系统自动开始解析
4. 解析状态会实时更新

### 查看解析结果
1. 在发票列表中点击"查看"按钮
2. 在详情弹窗中查看：
   - 解析状态
   - 提取的发票信息
   - OCR原始文本（如果可用）
   - 错误信息（如果解析失败）

### 重新解析
1. 在发票详情弹窗中
2. 点击"重新解析"按钮
3. 等待解析完成
4. 查看更新后的结果

## 常见问题

### Q: 为什么有些发票无法解析？
A: 可能的原因：
- PDF是扫描版，需要OCR但Tesseract未正确安装
- PDF文件损坏或格式不标准
- 发票格式不在支持范围内

### Q: 如何查看解析失败的原因？
A: 在发票详情中查看"解析错误"字段，会显示具体的错误信息。

### Q: 原始文本有什么用？
A: 原始文本可以帮助：
- 了解OCR提取了哪些内容
- 调试为什么某些字段未能正确识别
- 手动验证提取结果的准确性

## 未来改进方向
- 支持更多发票格式
- 改进OCR识别准确率
- 增加发票模板自定义功能
- 批量重新解析功能
- 发票数据人工校正功能
